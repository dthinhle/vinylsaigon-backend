<h1>Xác nhận đơn hàng</h1>

<p>Kính gửi<% if @order.user&.email.present? %> <%= @order.user.email %><% end %>,</p>

<p>Cảm ơn bạn đã đặt hàng! Chúng tôi đã nhận được đơn hàng và đang xử lý.</p>

<div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; background-color: #f8f9fa;">
  <h2>Chi tiết đơn hàng</h2>
  <p><strong>Số đơn hàng:</strong> <%= @order.order_number %></p>
  <p><strong>Ngày đặt:</strong> <%= @order.created_at.strftime("%d/%m/%Y %H:%M") %></p>
  <p><strong>Trạng thái:</strong> <span style="background-color: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;"><%= @order.status.titleize %></span></p>
</div>

<div style="margin: 20px 0;">
  <h3>Sản phẩm:</h3>

  <% @order_items.each do |item| %>
    <div style="border-bottom: 1px solid #eee; padding: 15px 0; display: flex; align-items: center;">
      <% if item.product.images.present? %>
        <img src="<%= url_for(item.product.images.first) %>" alt="<%= item.product_name %>" style="width: 80px; height: 80px; object-fit: cover; margin-right: 15px; border-radius: 4px;">
      <% end %>

      <div style="flex: 1;">
        <h4 style="margin: 0 0 5px 0; font-size: 16px;"><%= item.product_name %></h4>

        <% if item.product_variant.present? && item.metadata.key?('variant_name') %>
          <p style="margin: 0; color: #666; font-size: 14px;">
            Loại: <%= item.product_variant.name %> &nbsp;
          </p>
        <% end %>

        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Số lượng: <%= item.quantity %></p>
        <p style="margin: 5px 0 0 0; font-weight: bold; font-size: 16px;"><%= format_vnd_currency(item.unit_price_vnd) %> /sản phẩm</p>
      </div>

      <div style="text-align: right;">
        <p style="margin: 0; font-weight: bold; font-size: 18px;"><%= format_vnd_currency(item.subtotal_vnd) %></p>
      </div>
    </div>
  <% end %>
</div>

<div style="border-top: 2px solid #ddd; padding-top: 15px; margin: 20px 0;">
  <div style="display: flex; justify-content: space-between; margin: 8px 0;">
    <span>Tạm tính:</span>
    <span style="font-weight: bold;"><%= format_vnd_currency(@order.subtotal_vnd) %></span>
  </div>

  <% if @order.shipping_vnd > 0 %>
    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
      <span>Phí vận chuyển:</span>
      <span style="font-weight: bold;"><%= format_vnd_currency(@order.shipping_vnd) %></span>
    </div>
  <% end %>

  <% if @order.tax_vnd > 0 %>
    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
      <span>Thuế:</span>
      <span style="font-weight: bold;"><%= format_vnd_currency(@order.tax_vnd) %></span>
    </div>
  <% end %>

  <% if @order.discount_vnd > 0 %>
    <div style="display: flex; justify-content: space-between; margin: 8px 0; color: #28a745;">
      <span>Giảm giá:</span>
      <span style="font-weight: bold;">-<%= format_vnd_currency(@order.discount_vnd) %></span>
    </div>
  <% end %>

  <div style="display: flex; justify-content: space-between; margin: 15px 0 0 0; padding-top: 10px; border-top: 1px solid #ddd; font-size: 20px;">
    <span style="font-weight: bold;">Tổng cộng:</span>
    <span style="font-weight: bold;"><%= format_vnd_currency(@order.total_vnd) %></span>
  </div>
</div>

<% if @shipping_address.present? %>
  <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 20px 0;">
    <h3 style="margin-top: 0;">Địa chỉ giao hàng</h3>
    <p style="margin: 5px 0;"><%= @shipping_address['name'] %></p>
    <p style="margin: 5px 0;"><%= @shipping_address['address_line1'] %></p>
    <% if @shipping_address['address_line2'].present? %>
      <p style="margin: 5px 0;"><%= @shipping_address['address_line2'] %></p>
    <% end %>
    <p style="margin: 5px 0;"><%= @shipping_address['city'] %>, <%= @shipping_address['state'] %> <%= @shipping_address['postal_code'] %></p>
    <p style="margin: 5px 0;"><%= @shipping_address['country'] %></p>
    <% if @shipping_address['phone'].present? %>
      <p style="margin: 5px 0;">Số điện thoại: <%= @shipping_address['phone'] %></p>
    <% end %>
  </div>
<% end %>

<% if @billing_address.present? && @billing_address != @shipping_address %>
  <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 20px 0;">
    <h3 style="margin-top: 0;">Địa chỉ thanh toán</h3>
    <p style="margin: 5px 0;"><%= @billing_address['name'] %></p>
    <p style="margin: 5px 0;"><%= @billing_address['address_line1'] %></p>
    <% if @billing_address['address_line2'].present? %>
      <p style="margin: 5px 0;"><%= @billing_address['address_line2'] %></p>
    <% end %>
    <p style="margin: 5px 0;"><%= @billing_address['city'] %>, <%= @billing_address['state'] %> <%= @billing_address['postal_code'] %></p>
    <p style="margin: 5px 0;"><%= @billing_address['country'] %></p>
  </div>
<% end %>

<div style="text-align: center; margin: 30px 0;">
  <%= link_to "Theo dõi đơn hàng", "#{FRONTEND_HOST}/tra-cuu-don-hang?email=#{@order.email}&order_number=#{@order.order_number}", target: '_blank', style: "background-color: #007bff; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;" %>
</div>

<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
  <p><strong>Cần hỗ trợ?</strong></p>
  <p>Nếu bạn có bất kỳ câu hỏi nào về đơn hàng, vui lòng liên hệ với đội ngũ hỗ trợ của chúng tôi tại 3kshop1@gmail.com hoặc gọi cho chúng tôi theo số <a target="_blank" rel="noopener noreferrer" href="https://zalo.me/0914345357">0914 345 357</a>.</p>
  <p>Số đơn hàng: <%= @order.order_number %></p>
</div>

<p>Cảm ơn bạn đã mua sắm tại 3K Shop!</p>

<p>
  Trân trọng.
</p>
