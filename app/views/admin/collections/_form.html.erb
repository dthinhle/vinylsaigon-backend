<%= form_with model: @collection, url: @collection.persisted? ? admin_collection_path(@collection) : admin_collections_path, local: false, html: { id: "collection-form", class: "w-[min(var(--container-xl),100vw)] mx-auto rounded-lg border border-gray-200 bg-white", multipart: true } do |f| %>
  <div class="flex flex-row items-center justify-between py-4 px-4 border-b border-gray-200">
    <div class="flex items-center gap-2">
      <%= link_to admin_collections_path, class: "bg-white border border-gray-200 hover:bg-gray-100 text-gray-700 px-2 py-1.5 rounded" do %>
        <span class="material-icons text-base align-middle">chevron_left</span>
      <% end %>
      <h2 class="text-2xl font-bold"><%= @collection.persisted? ? "Edit Collection" : "New Collection" %></h2>
    </div>
    <div>
      <%= button_tag type: "submit", class: "bg-gray-950 hover:bg-gray-700 text-white text-sm font-semibold py-2 px-4 rounded transition-colors flex flex-row items-center gap-1" do %>
        <span class="material-icons text-base/6! align-middle">check_circle</span>
        <span>Save</span>
      <% end %>
    </div>
  </div>

  <div class="p-4 space-y-4">
    <%= render "admins/shared/error_messages", resource: @collection %>

    <div>
      <%= f.label :name, "Name", class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :name, required: true, class: "input input-bordered text-sm w-full px-3 py-2 rounded border border-gray-300 focus:ring-sky-500 #{'border-red-500' if @collection.errors[:name].any?}", autofocus: true %>
      <% if @collection.errors[:name].any? %>
        <div class="text-red-600 text-xs mt-1" role="alert"><%= @collection.errors[:name].first %></div>
      <% end %>
    </div>

    <div>
      <%= f.label :description, "Description", class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_area :description, rows: 3, maxlength: 80, class: "textarea textarea-bordered text-sm w-full px-3 py-2 rounded border border-gray-300 focus:ring-2 focus:ring-sky-500 #{'border-red-500' if @collection.errors[:description].any?}" %>
      <p class="text-xs text-gray-500 mt-1">Maximum 80 characters</p>
      <% if @collection.errors[:description].any? %>
        <div class="text-red-600 text-xs mt-1" role="alert"><%= @collection.errors[:description].first %></div>
      <% end %>
    </div>

    <div>
      <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
        <%= f.check_box :active, class: "checkbox checkbox-primary size-4 accent-gray-950" %>
        <span>Active</span>
      </label>
      <p class="text-xs text-gray-500 mt-1">Inactive collections won't appear in the API</p>
      <% if @collection.errors[:active].any? %>
        <div class="text-red-600 text-xs mt-1" role="alert"><%= @collection.errors[:active].first %></div>
      <% end %>
    </div>

    <div>
      <%= f.label :thumbnail, "Thumbnail Image", class: "block text-sm font-medium text-gray-700" %>
      <%= f.file_field :thumbnail, class: "file-input file-input-bordered w-full px-3 py-2 rounded border border-gray-300 focus:ring-2 focus:ring-sky-500", accept: "image/*" %>
      <% if @collection.errors[:thumbnail].any? %>
        <div class="text-red-600 text-xs mt-1" role="alert"><%= @collection.errors[:thumbnail].first %></div>
      <% end %>
      <% if @collection.thumbnail.attached? %>
        <div class="mt-2">
          <%= image_tag @collection.thumbnail.variant(:thumbnail), class: "rounded border border-gray-200 max-h-32" %>
        </div>
      <% end %>
    </div>

    <% if @collection.seeded_collection? %>
      <div class="rounded border border-amber-500 bg-amber-50 p-4 dark:border-amber-500/30 dark:bg-amber-500/15 flex items-start gap-3 text-amber-700">
        <span class="material-icons text-xl flex-shrink-0">warning</span>
        <div>
          <p class="font-medium">Auto-Generated Collection</p>
          <p class="text-sm mt-1">This collection's product list is automatically updated and cannot be manually edited. Only the name, description, thumbnail, and active status can be changed.</p>
        </div>
      </div>
    <% else %>
      <div>
        <%= f.label :product_ids, "Products", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= f.collection_select :product_ids,
          Product.active.order(:name),
          :id,
          :name,
          { selected: @collection.product_ids },
          {
            multiple: true,
            class: "select select-bordered w-full rounded border border-gray-300 focus:ring-2 focus:ring-sky-500",
            size: 6,
            data: { controller: "tom-select" }
          }
        %>
        <p class="text-xs text-gray-500 mt-1">Select products to include in this collection</p>
        <% if @collection.errors[:product_ids].any? %>
          <div class="text-red-600 text-xs mt-1" role="alert"><%= @collection.errors[:product_ids].first %></div>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
