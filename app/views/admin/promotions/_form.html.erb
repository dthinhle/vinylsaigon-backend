<%= form_with model: @promotion, url: @promotion.persisted? ? admin_promotion_path(@promotion) : admin_promotions_path, local: false, html: { id: "promotion-form", class: "w-[min(var(--container-xl),100vw)] mx-auto rounded-lg border border-gray-200 bg-white", multipart: true }, data: { controller: "bundle-promotion" } do |f| %>
  <div class="flex flex-row items-center justify-between py-4 px-4 border-b border-gray-200">
    <div class="flex items-center gap-2">
      <%= link_to admin_promotions_path, class: "bg-white border border-gray-200 hover:bg-gray-100 text-gray-700 px-2 py-1.5 rounded" do %>
        <span class="material-icons text-base align-middle">chevron_left</span>
      <% end %>
      <h2 class="text-2xl font-bold"><%= @promotion.persisted? ? "Edit Promotion" : "New Promotion" %></h2>
    </div>
    <div>
      <%= button_tag type: "submit", class: "bg-gray-950 hover:bg-gray-700 text-white text-sm font-semibold py-2 px-4 rounded transition-colors flex flex-row items-center gap-1" do %>
        <span class="material-icons text-base/6! align-middle">check_circle</span>
        <span>Save</span>
      <% end %>
    </div>
  </div>

  <div class="p-4 space-y-6">
    <%= render "admins/shared/error_messages", resource: @promotion %>

    <div class="pb-4 border-b border-gray-200 space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Basic Information</h3>

      <div>
        <%= f.label :title, "Title", class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_field :title, required: true, class: "input input-bordered text-sm w-full px-3 py-2 rounded border border-gray-300 focus:ring-sky-500 #{'border-red-500' if @promotion.errors[:title].any?}", autofocus: true, placeholder: "e.g., Summer Sale 2025" %>
        <% if @promotion.errors[:title].any? %>
          <div class="text-red-600 text-xs mt-1" role="alert"><%= @promotion.errors[:title].first %></div>
        <% end %>
      </div>

      <div>
        <%= f.label :code, "Promotion Code", class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_field :code, required: true, autocomplete: "off", maxlength: 64, class: "input input-bordered text-sm w-full px-3 py-2 rounded border border-gray-300 focus:ring-sky-500 #{'border-red-500' if @promotion.errors[:code].any?}", placeholder: "e.g., SUMMER2025" %>
        <% if @promotion.errors[:code].any? %>
          <div class="text-red-600 text-xs mt-1" role="alert"><%= @promotion.errors[:code].first %></div>
        <% end %>
        <p class="text-xs text-gray-600 mt-1">Unique code users enter at checkout. Max 64 characters. Use uppercase letters, numbers, and hyphens.</p>
      </div>
    </div>

    <div class="pb-4 border-b border-gray-200 space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Discount Configuration</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <%= f.label :discount_type, "Discount Type", class: "block text-sm font-medium text-gray-700" %>
          <%= f.select :discount_type, Promotion.discount_types.keys.map { |k| [k.humanize.capitalize, k] }, {},
            class: "select select-bordered w-full pl-1.5 pr-3 py-2.25 rounded border border-gray-300 focus:ring-2 focus:ring-sky-500 #{'border-red-500' if @promotion.errors[:discount_type].any?}",
            data: { action: "change->bundle-promotion#toggleBundleSection" } %>
          <% if @promotion.errors[:discount_type].any? %>
            <div class="text-red-600 text-xs mt-1" role="alert"><%= @promotion.errors[:discount_type].first %></div>
          <% end %>
          <p class="text-xs text-gray-600 mt-1">Choose between percentage, fixed amount, or bundle discount</p>
        </div>

        <div data-bundle-promotion-target="discountValueField">
          <%= f.label :discount_value, "Discount Value", class: "block text-sm font-medium text-gray-700" %>
          <%= f.number_field :discount_value, step: "0.01", class: "input input-bordered text-sm w-full px-3 py-2 rounded border border-gray-300 focus:ring-sky-500 #{ 'border-red-500' if @promotion.errors[:discount_value].any? }", placeholder: "e.g., 10 or 50000" %>
          <% if @promotion.errors[:discount_value].any? %>
            <div class="text-red-600 text-xs mt-1" role="alert"><%= @promotion.errors[:discount_value].first %></div>
          <% end %>
          <p class="text-xs text-gray-600 mt-1">For percentage: 10 = 10% off. For fixed/bundle: amount in VND</p>
        </div>
      </div>

      <%# Max discount cap for percentage promotions %>
      <div data-bundle-promotion-target="maxDiscountField">
        <% if @promotion.discount_type == 'percentage' || @promotion.new_record? %>
          <div>
            <%= f.label :max_discount_amount_vnd, "Maximum Discount Cap (VND)", class: "block text-sm font-medium text-gray-700" %>
            <%= f.number_field :max_discount_amount_vnd, min: 0, step: 1, class: "input input-bordered text-sm w-full px-3 py-2 rounded border border-gray-300 focus:ring-sky-500 #{ 'border-red-500' if @promotion.errors[:max_discount_amount_vnd].any? }", placeholder: "e.g., 100000 (leave 0 for no cap)" %>
            <% if @promotion.errors[:max_discount_amount_vnd].any? %>
              <div class="text-red-600 text-xs mt-1" role="alert"><%= @promotion.errors[:max_discount_amount_vnd].first %></div>
            <% end %>
            <p class="text-xs text-gray-600 mt-1">Only applies to percentage promotions. Set maximum discount amount in VND. Enter 0 for no cap.</p>
          </div>
        <% end %>
      </div>

      <%# Bundle Products Section %>
      <div data-bundle-promotion-target="bundleSection" style="<%= 'display: none;' unless @promotion.bundle? %>" class="space-y-4 pt-4">
        <div class="flex items-center justify-between">
          <h4 class="text-base font-medium text-gray-900">Bundle Products</h4>
          <button type="button" data-action="click->bundle-promotion#addBundleItem" class="btn btn-sm bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1.5 rounded text-sm flex items-center gap-1">
            <span class="material-icons text-base">add</span>
            <span>Add Product</span>
          </button>
        </div>

        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <p class="text-sm text-gray-600 mb-4">Select products that must be purchased together for this bundle discount to apply. Minimum 2 products required.</p>

          <div id="bundle-items-container" data-bundle-promotion-target="bundleItemsContainer" class="space-y-3">
            <%= f.fields_for :product_bundles do |bundle_form| %>
              <%= render 'product_bundle_fields', f: bundle_form %>
            <% end %>
          </div>

          <% if @promotion.errors[:product_bundles].any? %>
            <div class="text-red-600 text-sm mt-2" role="alert"><%= @promotion.errors[:product_bundles].first %></div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="pb-4 border-b border-gray-200 space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Validity Period</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <%= f.label :starts_at, "Start Date & Time", class: "block text-sm font-medium text-gray-700" %>
          <%= f.datetime_field :starts_at, class: "input input-bordered text-sm w-full px-3 py-2 rounded border border-gray-300 focus:ring-sky-500 #{'border-red-500' if @promotion.errors[:starts_at].any?}" %>
          <% if @promotion.errors[:starts_at].any? %>
            <div class="text-red-600 text-xs mt-1" role="alert"><%= @promotion.errors[:starts_at].first %></div>
          <% end %>
          <p class="text-xs text-gray-600 mt-1">When the promotion becomes active</p>
        </div>

        <div>
          <%= f.label :ends_at, "End Date & Time", class: "block text-sm font-medium text-gray-700" %>
          <%= f.datetime_field :ends_at, class: "input input-bordered text-sm w-full px-3 py-2 rounded border border-gray-300 focus:ring-sky-500 #{'border-red-500' if @promotion.errors[:ends_at].any?}" %>
          <% if @promotion.errors[:ends_at].any? %>
            <div class="text-red-600 text-xs mt-1" role="alert"><%= @promotion.errors[:ends_at].first %></div>
          <% end %>
          <p class="text-xs text-gray-600 mt-1">When the promotion expires (optional)</p>
        </div>
      </div>
    </div>

    <div class="space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Usage & Settings</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <%= f.label :usage_limit, "Usage Limit", class: "block text-sm font-medium text-gray-700" %>
          <%= f.number_field :usage_limit, min: 0, class: "input input-bordered text-sm w-full px-3 py-2 rounded border border-gray-300 focus:ring-2 focus:ring-sky-500 #{'border-red-500' if @promotion.errors[:usage_limit].any?}", placeholder: "e.g., 100 (0 for unlimited)" %>
          <% if @promotion.errors[:usage_limit].any? %>
            <div class="text-red-600 text-xs mt-1" role="alert"><%= @promotion.errors[:usage_limit].first %></div>
          <% end %>
          <p class="text-xs text-gray-600 mt-1">Maximum number of times this code can be used. Leave 0 for unlimited.</p>
        </div>

        <div>
          <%= f.label :usage_count, "Current Usage Count", class: "block text-sm font-medium text-gray-700" %>
          <%= f.number_field :usage_count, value: @promotion.usage_count || 0, disabled: true, class: "input input-bordered text-sm w-full px-3 py-2 rounded bg-gray-100 border border-gray-200" %>
          <p class="text-xs text-gray-600 mt-1">Number of times this code has been used (read-only)</p>
        </div>
      </div>

      <div class="flex flex-col gap-3 pt-2">
        <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
          <%= f.check_box :active, class: "checkbox checkbox-primary size-4 accent-gray-950" %>
          <span>Active</span>
        </label>
        <p class="text-xs text-gray-600 ml-6 -mt-2">Enable this promotion for customers to use</p>

        <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
          <%= f.check_box :stackable, class: "checkbox checkbox-primary size-4 accent-gray-950" %>
          <span>Stackable</span>
        </label>
        <p class="text-xs text-gray-600 ml-6 -mt-2">Allow this promotion to be combined with other promotions</p>
      </div>
    </div>
  </div>
<% end %>
