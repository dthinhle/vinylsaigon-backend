<% if product.persisted? %>
  <% versions = ProductVersionService.versions_for(product, limit: 10) %>
  <% if versions.any? %>
    <div class="version-wrapper">
      <div class="block text-sm font-medium text-gray-700">
        Version History
      </div>
      <div class="space-y-2 max-h-80 overflow-y-auto">
        <% versions.each_with_index do |version, index| %>
          <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 transition">
            <div class="flex items-start justify-between gap-2">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                    <%= version[:event] == 'create' ? 'bg-green-100 text-green-800' :
                        version[:event] == 'update' ? 'bg-blue-100 text-blue-800' :
                        'bg-red-100 text-red-800' %>">
                    <%= version[:event].capitalize %>
                  </span>
                  <span class="text-xs text-gray-500">
                    <%= version[:changes_count] %> change<%= version[:changes_count] > 1 ? 's' : '' %>
                  </span>
                </div>
                <p class="text-sm text-gray-700 mt-1 truncate">
                  <%= version[:admin_email] %>
                </p>
                <p class="text-xs text-gray-400 mt-0.5">
                  <%= time_ago_in_words(version[:created_at]) %> ago
                </p>
                <% if version[:changed_columns].present? %>
                  <div class="flex flex-wrap gap-1 mt-1">
                    <% version[:changed_columns].each do |column| %>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-100 text-gray-600">
                        <%= column.to_s.humanize %>
                      </span>
                    <% end %>
                  </div>
                <% end %>
              </div>
              <% if index > 0 %>
                <%= link_to revert_admin_product_path(product, transaction_id: version[:transaction_id]),
                    class: "btn btn-sm px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-100 transition flex items-center gap-1 whitespace-nowrap",
                    data: {
                      turbo_method: :post,
                      turbo_confirm: "Are you sure you want to revert to this version? This will restore the product and all its variants to their state at #{version[:created_at].strftime('%Y-%m-%d %H:%M')}."
                    } do %>
                  <span class="material-icons text-sm!">undo</span>
                  <span>Revert</span>
                <% end %>
              <% else %>
                <span class="text-xs text-gray-400 italic px-2 py-1">Current</span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>
